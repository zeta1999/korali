#include "modules/problem/bayesian/latent/exponentialLatent/exponentialLatent.hpp"
#include <vector>


/*! @brief The problem initialization; here, remember indices of latent vs. hyperparameters for easy access later on */
void korali::problem::bayesian::latent::ExponentialLatent::initialize()
{
  korali::problem::Bayesian::initialize();

 _latentVariableIndices.clear();
 _hyperparameterVariableIndices.clear();

 for (size_t i = 0; i < _k->_variables.size(); i++)
 {
  std::string typeString = _k->_variables[i]->_bayesianType;
  bool recognizedType = false;
  if (typeString == "Hyperparameter")
  {
    _hyperparameterVariableIndices.push_back(i);
    recognizedType = true;
  }
  if (typeString == "Latent")
  {
    _latentVariableIndices.push_back(i);
    recognizedType = true;
  }
  if (recognizedType == false) korali::Logger::logError("Incorrect Bayesian variable type selected: %s.\n", typeString.c_str());
 }
}

/*! @brief Given 'Hyperparameters' and 'Latent Variables' (parameters the sample is expected to have), calculate
          the total log probability.
*/
void korali::problem::bayesian::latent::ExponentialLatent::evaluateLogPosterior(korali::Sample& sample){
    // Evaluate the user-given probability distribution for latent- and hyperparameter values given in the sample
  sample.run(_sOfLikelihoodModel);
  sample.run(_zetaOfLikelihoodModel);
  sample.run(_phiOfLikelihoodModel);
  // -> Assume these set: sample["S"], sample["zeta"] and sample["phi"]

  if (! sample.contains("S")) korali::Logger::logError("The specified likelihood model did not assign the value: 'S' to the sample.\n");
  if (! sample.contains("zeta")) korali::Logger::logError("The specified likelihood model did not assign the value: 'zeta' to the sample.\n");
  if (! sample.contains("phi")) korali::Logger::logError("The specified likelihood model did not assign the value: 'phi' to the sample.\n");


  double _zetaValue = -korali::Inf;
  std::vector<double> _sValues;
  std::vector<double> _phiValues;

  try
  {
    _zetaValue = sample["zeta"].get<double>();
  }
  catch (const std::exception &e)
  {
    korali::Logger::logError("Missing or incorrect value of 'zeta' returned by the sample evaluation. \n   + Solution: Make sure your model is storing its zeta values, e.g., sample[\"zeta\"] = value(s).\n   + Cause: %s\n", e.what());
  }
  try
  {
    _sValues = sample["S"].get<std::vector<double>>();
  }
  catch (const std::exception &e)
  {
    korali::Logger::logError("Missing or incorrect value of 'S' returned by the sample evaluation. \n   + Solution: Make sure your model is storing its S values, e.g., sample[\"S\"] = value(s).\n   + Cause: %s\n", e.what());
  }
  try
  {
    _phiValues = sample["phi"].get<std::vector<double>>();
  }
  catch (const std::exception &e)
  {
    korali::Logger::logError("Missing or incorrect value of 'phi' returned by the sample evaluation. \n   + Solution: Make sure your model is storing its phi values, e.g., sample[\"phi\"] = value(s).\n   + Cause: %s\n", e.what());
  }

  sample["Log Posterior"] = - _zetaValue + std::inner_product(std::begin(_sValues), std::end(_sValues), std::begin(_phiValues), 0.0);
}

/*! @brief run the user defined sampler.
    Input sample needs to contain:
      - sample["Hyperparameters"]
      - sample["Number Samples"]

    Values that will be set:
      - sample["Samples"]
 */
void korali::problem::bayesian::latent::ExponentialLatent::sampleLatent(korali::Sample& sample)
{
  sample["Number Of Latent Variables"] = _latentVariableIndices.size();
  sample.run(_latentVariableSampler);
}

/*! @brief Evaluate the user-defined 'S' function (the sufficient statistics of the distribution).
          sample is expected to contain parameter 'Latent Variables' */
void korali::problem::bayesian::latent::ExponentialLatent::evaluateS(korali::Sample& sample){
  sample.run(_sOfLikelihoodModel);
}

/*! @brief Evaluate the user-defined 'phi' function (log-llh = -zeta + <S, phi>).
          sample is expected to contain parameter 'Hyperparameters' */
void korali::problem::bayesian::latent::ExponentialLatent::evaluatePhi(korali::Sample& sample)
{
  sample.run(_phiOfLikelihoodModel);
}

/*! @brief Evaluate the user-defined 'zeta' function (~ the log-normalization constant of the distribution).
          sample is expected to contain parameter 'Hyperparameters' */
void korali::problem::bayesian::latent::ExponentialLatent::evaluateZeta(korali::Sample& sample)
{
  sample.run(_zetaOfLikelihoodModel);
}
